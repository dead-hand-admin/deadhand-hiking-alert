# Реализация системы коротких ссылок для действий без авторизации

## Выполненные изменения

### 1. Удалены неиспользуемые ключи переводов
Из `lang/ru.php` и `lang/en.php` удалены:
- `trip_stage_location`
- `trip_stage_location_placeholder`
- `trip_stage_duration_days`
- `trip_stage_duration_hours`

### 2. Улучшен UX
- Время дедлайна — выпадающий список с шагом 30 минут
- "Описание" этапа переименовано в "Название"
- Удалены избыточные заголовки в формах

### 3. Упрощена логика создания походов
**ВАЖНО:** Походы всегда создаются как черновики.
- Убрано поле "Дата начала" из формы создания
- Убрана кнопка "Создать поход"
- Осталась только кнопка "Сохранить" — всегда создаёт черновик
- `start_date` устанавливается автоматически при активации (текущая дата)
- Активировать поход можно только из списка походов

### 4. Реализовано редактирование черновиков
- Редактирование только черновиков
- Можно изменять: название, страну, службу спасения, все этапы
- При редактировании загружаются текущие значения
- **Отображение загруженных файлов** (трек, фото) с кнопками удаления
- Этапы пересоздаются при сохранении

**Ограничения:**
- Активный поход не редактируется
- Завершённые/отменённые — только копирование
- Активный поход нельзя удалить

### 5. Переработан список походов
**Новая логика:**
- "Активные" без счётчика (может быть только один)
- Клик на название или стрелку → раскрывает этапы прямо в списке
- Кнопки действий вынесены в список:
  - Черновики: Редактировать, Активировать, Удалить
  - Активный: Отменить
  - Завершённые/Отменённые: Копировать
- **Страница view больше не нужна** — всё в списке

### 6. Исправлена race condition в генерации токенов
**Проблема:** Два пользователя могли сгенерировать одинаковый токен одновременно.

**Решение:**
- `create()` переименован в `generateToken()` (конфликт с BaseModel::create)
- Использован **do-while цикл** для атомарности:
  1. Проверка существования токена для `trip_id + action`
  2. Если нет — генерация и `INSERT IGNORE`
  3. Если вставка не удалась — повтор (либо токен занят, либо другая сессия создала)
- Добавлен `UNIQUE KEY (trip_id, action)` в миграцию
- Метод `generateRandomToken()` вынесен отдельно

### 7. Создана система action tokens

**Новая миграция:** `migrations/008_action_tokens.sql`
Таблица `action_tokens` для хранения токенов действий:
- `token` — 8-символьный код (исключены похожие: 0, O, l, I, 1)
- `trip_id` — привязка к походу
- `action` — тип действия (cancel_trip, complete_trip, confirm_stage, extend_stage)
- `expires_at` — срок действия (30 дней)

**ВАЖНО:** Токены многоразовые! Один токен на действие, работает до истечения срока.

**Новая модель:** `app/Models/ActionToken.php`
Методы:
- `create()` — создание токена (если уже есть — возвращает существующий)
- `findByToken()` — получение токена
- `generateTripTokens()` — генерация всех 4 токенов для похода

**Новый контроллер:** `app/Controllers/ActionController.php`
Обработка действий по токенам через роут `/action?t=TOKEN`
- `confirm_stage` и `extend_stage` работают с текущим активным этапом
- `cancel_trip` и `complete_trip` меняют статус активного похода

### 8. Созданы шаблоны для действий
Директория `templates/action/`:
- `error.php` — ошибка (неверный/просроченный токен, нет активного этапа)
- `success.php` — успешное выполнение
- `confirm_stage.php` — подтверждение активного этапа
- `cancel_trip.php` — отмена похода
- `complete_trip.php` — завершение похода
- `extend_stage.php` — продление активного этапа (2 режима: +часы или на дату)

### 9. Интегрирована генерация токенов

**В `TripController::confirm()`:**
При активации похода генерируются 4 токена один раз:
- confirm_stage — для любого активного этапа
- extend_stage — для любого активного этапа
- cancel_trip — для активного похода
- complete_trip — для активного похода

**Токены не пересоздаются** при переходе между этапами — работают все время похода.

### 10. Обновлён роутинг
`index.php`:
- Удалён роут `/stage/extend` (не реализован метод)
- Добавлен роут `/action` → `ActionController::handle()`

### 11. Добавлены переводы
Новые ключи в `lang/ru.php` и `lang/en.php`:
- `hours`, `days` — единицы времени
- `error_trip_not_active`, `error_no_active_stage` — ошибки
- `action_*` — все тексты для страниц действий (26 ключей)

## Инструкция по установке

### 1. Запустить миграцию
```bash
php migrations/run.php
```

### 2. Заменить файлы
- `index.php`
- `lang/ru.php`
- `lang/en.php`
- `templates/trips/create.php`
- `templates/trips/index.php` (← новый список с раскрытием)
- `app/Controllers/TripController.php`
- `app/Services/TripService.php`

### 3. Добавить новые файлы
- `migrations/008_action_tokens.sql`
- `templates/trips/edit.php`
- `app/Models/ActionToken.php`
- `app/Controllers/ActionController.php`
- `templates/action/` (вся директория)

### 4. Можно удалить (не используются)
- `templates/trips/view.php` — заменён списком с раскрытием

## Использование в письмах

При активации похода генерируются токены один раз:

```php
// В методе TripController::confirm() после активации:
$tokens = $tokenModel->generateTripTokens($tripId);

// Короткие ссылки для письма (действуют весь поход):
$confirmUrl = "https://yourdomain.com/action?t={$tokens['confirm_stage']}";
$extendUrl = "https://yourdomain.com/action?t={$tokens['extend_stage']}";
$cancelUrl = "https://yourdomain.com/action?t={$tokens['cancel_trip']}";
$completeUrl = "https://yourdomain.com/action?t={$tokens['complete_trip']}";
```

**Пример короткой ссылки:** `/action?t=3H7K9P2M`
- 8 символов
- Без похожих букв/цифр (легко диктовать по телефону)
- Срок действия 30 дней
- **Многоразовое использование** — можно использовать сколько угодно раз

## Логика работы

### Подтверждение этапа (confirm_stage)
1. Открываем `/action?t=TOKEN`
2. Находим активный этап похода
3. Показываем информацию о текущем и следующем этапах
4. При подтверждении:
   - Текущий этап → confirmed
   - Следующий этап → active (если есть)
   - Или поход → completed (если этап последний)

### Продление этапа (extend_stage)
1. Открываем `/action?t=TOKEN`
2. Находим активный этап похода
3. Два режима продления:
   - **Добавить часы:** +1..72 часа к текущему дедлайну
   - **Перенести на дату:** указать новую дату и время

### Отмена похода (cancel_trip)
- Проверяем, что поход активен
- Статус → cancelled
- Все pending алерты → cancelled

### Завершение похода (complete_trip)
- Проверяем, что поход активен
- Статус → completed
- Все pending алерты → cancelled

## Особенности реализации

**Токены привязаны к походу, а не к этапам:**
- `confirm_stage` всегда работает с текущим активным этапом
- `extend_stage` всегда работает с текущим активным этапом
- Не нужно пересоздавать токены при переходе между этапами

**Одни токены на весь поход:**
- Генерируются при активации
- Работают до завершения/отмены похода или истечения 30 дней
- Можно включать в каждое письмо без изменений

## Что осталось сделать

1. **Email-интеграция**
   - Отправка писем с токенами при активации
   - Отправка напоминаний с теми же токенами

2. **Cron-скрипт**
   - Проверка просроченных этапов
   - Формирование alert_queue
   - Отправка оповещений контактам и в МЧС

3. **Дополнительные проверки**
   - Валидация дат при продлении (не раньше текущего дедлайна)
   - Логирование всех действий через токены

## Безопасность

- Токены генерируются криптографически случайно
- Исключены похожие символы (удобно диктовать)
- Токены многоразовые, но с ограниченным сроком действия
- Автоматическое истечение через 30 дней
- Привязка к походу (нельзя использовать для чужого похода)
- Действия только с активным походом/этапом